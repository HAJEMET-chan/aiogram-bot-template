# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–∞ aiogram-–±–æ—Ç–∞

## –û–±–∑–æ—Ä

–≠—Ç–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram-–±–æ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ **aiogram 3.x**. –®–∞–±–ª–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∫—É webhook –∏ polling —Ä–µ–∂–∏–º–æ–≤.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **aiogram 3.x** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API
- **asyncpg** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQL
- **redis** - –¥–ª—è FSM (Finite State Machine) –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- **structlog** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **pydantic** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **aiohttp** - –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è webhook —Ä–µ–∂–∏–º–∞
- **aiojobs** - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- **tenacity** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
- **orjson** - –±—ã—Å—Ç—Ä–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è JSON

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
bowling_bot/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ bot.py                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ config.py            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ db_api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ storages/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ base.py      # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ postgres.py  # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è PostgreSQL
‚îÇ   ‚îú‚îÄ‚îÄ repositories/        # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ cache/               # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)
‚îú‚îÄ‚îÄ exceptions/              # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ filters/                 # –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
‚îú‚îÄ‚îÄ handlers/                # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ user/               # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ keyboards/               # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (inline –∏ reply)
‚îÇ   ‚îú‚îÄ‚îÄ default/            # Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ inline/             # Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ keyboard_utils/     # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä
‚îú‚îÄ‚îÄ middlewares/             # Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ models/                  # Pydantic –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ states/                  # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îú‚îÄ‚îÄ utils/                   # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îî‚îÄ‚îÄ web_handlers/            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è webhook
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. bot.py - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞

–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–æ—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

- `main()` - —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä—ã Bot –∏ Dispatcher, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç storage (Redis –¥–ª—è FSM)
- `setup_aiogram()` - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –ë–î, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç handlers –∏ middlewares
- `create_db_connections()` - –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL –∏ Redis —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
- `setup_handlers()` - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- `setup_middlewares()` - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**

1. **Polling** (`USE_WEBHOOK=False`):
   - –ë–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É Telegram
   - –ü—Ä–æ—â–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ú–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

2. **Webhook** (`USE_WEBHOOK=True`):
   - Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
   - –¢—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π HTTPS URL
   - –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç aiohttp –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. data/config.py - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (environs).

**–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

- `BOT_TOKEN` - —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç BotFather
- `PG_*` - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `FSM_*` - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Redis –¥–ª—è FSM
- `CACHE_*` - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `USE_WEBHOOK` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (webhook/polling)
- `USE_CUSTOM_API_SERVER` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ API —Å–µ—Ä–≤–µ—Ä–∞
- `LOGGING_LEVEL` - —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. handlers/ - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –º–æ–¥—É–ª—è–º (user, admin –∏ —Ç.–¥.).

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```python
# handlers/user/__init__.py
def prepare_router() -> Router:
    user_router = Router()
    user_router.message.filter(ChatTypeFilter("private"))  # –§–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤
    user_router.message.register(start.start, CommandStart())
    return user_router
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:**

```python
# handlers/user/start.py
async def start(msg: types.Message, state: FSMContext) -> None:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
    await state.set_state(states.user.UserMainMenu.menu)
```

### 4. filters/ - –§–∏–ª—å—Ç—Ä—ã

–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

**ChatTypeFilter** - —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç–∏–ø—É —á–∞—Ç–∞:
```python
ChatTypeFilter("private")  # –¢–æ–ª—å–∫–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —á–∞—Ç—ã
ChatTypeFilter(["private", "group"])  # –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∏–ª–∏ –≥—Ä—É–ø–ø—ã
```

**TextFilter** - —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç–µ–∫—Å—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è:
```python
TextFilter("üè†–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")  # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
TextFilter(["—Ç–µ–∫—Å—Ç1", "—Ç–µ–∫—Å—Ç2"])  # –û–¥–Ω–æ –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π
```

### 5. keyboards/ - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã

–°–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ —É–¥–æ–±–Ω—ã–º API.

**Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (default/basic.py):**

```python
from bowling_bot.keyboards.default import BasicButtons

# –ü—Ä–æ—Å—Ç—ã–µ –∫–Ω–æ–ø–∫–∏
keyboard = BasicButtons.back()
keyboard = BasicButtons.cancel()
keyboard = BasicButtons.confirmation(add_back=True)

# –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
keyboard = BasicButtons.ask_for_users(
    "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    request_id=1,
    max_quantity=1
)
```

**Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:**

–ò—Å–ø–æ–ª—å–∑—É—é—Ç `InlineConstructor` —Å callback data —á–µ—Ä–µ–∑ Pydantic:

```python
from bowling_bot.keyboards.inline.callbacks import Action

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å callback
button = {
    "text": "–ö–Ω–æ–ø–∫–∞",
    "callback_data": Action(action="do_something")
}
```

**–°—Ö–µ–º–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:**

–°—Ö–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫:
```python
schema = [2, 1]  # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: 2 –∫–Ω–æ–ø–∫–∏, –≤—Ç–æ—Ä–∞—è: 1 –∫–Ω–æ–ø–∫–∞
btns = ["–ö–Ω–æ–ø–∫–∞1", "–ö–Ω–æ–ø–∫–∞2", "–ö–Ω–æ–ø–∫–∞3"]
```

### 6. states/ - FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç aiogram FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–∞.

```python
# states/user.py
class UserMainMenu(StatesGroup):
    menu = State()
    settings = State()
```

–°–æ—Å—Ç–æ—è–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis —á–µ—Ä–µ–∑ `RedisStorage`.

### 7. db/ - –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

- `BaseConnection` - –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å
- `PostgresConnection` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è PostgreSQL
- `SingleQueryResult` / `MultipleQueryResults` - –æ–±–µ—Ä—Ç–∫–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
db_conn: PostgresConnection = dp["db_conn"]

# –û–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç
result = await db_conn._fetchrow(
    "SELECT * FROM users WHERE id = $1",
    (user_id,)
)
user = result.convert(UserModel)  # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Pydantic –º–æ–¥–µ–ª—å

# –ù–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
results = await db_conn._fetch(
    "SELECT * FROM users WHERE active = $1",
    (True,)
)
users = results.convert(UserModel)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON/JSONB —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ orjson
- Connection pooling —á–µ—Ä–µ–∑ asyncpg
- –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### 7.1. db/repositories/ - –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** - —ç—Ç–æ –∫–ª–∞—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—Ç –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏?**

- **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞:** –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î –¥–ª—è –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ú–µ—Ç–æ–¥—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –õ–µ–≥–∫–æ —Å–æ–∑–¥–∞—Ç—å mock-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** SQL –∑–∞–ø—Ä–æ—Å—ã —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:**

```python
# db/repositories/user_repository.py
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from bowling_bot.db.db_api.storages.postgres import PostgresConnection

class UserRepository:
    def __init__(self, db_conn: "PostgresConnection") -> None:
        self.db_conn = db_conn
    
    async def get_by_telegram_id(self, telegram_id: int) -> dict | None:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID"""
        result = await self.db_conn._fetchrow(
            "SELECT * FROM users WHERE telegram_id = $1",
            (telegram_id,),
        )
        return result.data
    
    async def create(self, telegram_id: int, name: str) -> dict:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        await self.db_conn._execute(
            "INSERT INTO users (telegram_id, name) VALUES ($1, $2)",
            (telegram_id, name),
        )
        return await self.get_by_telegram_id(telegram_id)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:**

```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
async def handler(
    msg: types.Message,
    db_conn: "PostgresConnection",
) -> None:
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    user_repo = UserRepository(db_conn)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    user = await user_repo.get_by_telegram_id(msg.from_user.id)
    if user is None:
        user = await user_repo.create(
            telegram_id=msg.from_user.id,
            name=msg.from_user.full_name
        )
```

**–ü—Ä–∞–≤–∏–ª–æ:** –û–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π = –æ–¥–Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å (User, Order, Product –∏ —Ç.–¥.)

### 8. middlewares/ - Middleware

**StructLoggingMiddleware** - –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç update_id –∫–æ –≤—Å–µ–º –ª–æ–≥–∞–º
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç message, callback_query, inline_query –∏ –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã

### 9. utils/ - –£—Ç–∏–ª–∏—Ç—ã

**connect_to_services.py:**

- `wait_postgres()` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ (tenacity)
- `wait_redis_pool()` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

**logging.py:**

- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ structlog
- –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (rich)
- JSON –≤—ã–≤–æ–¥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**smart_session.py:**

- `SmartAiogramAiohttpSession` - —É–º–Ω–∞—è —Å–µ—Å—Å–∏—è —Å:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π `TelegramRetryAfter`
  - –ü–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞
  - –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏ —Å–±–æ—è—Ö
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API

**chunks.py:**

- –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –Ω–∞ —á–∞—Å—Ç–∏ (–¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)

### 10. models/ - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è Pydantic –º–æ–¥–µ–ª–µ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π orjson:

```python
from bowling_bot.models import BaseModel

class User(BaseModel):
    id: int
    name: str
    active: bool
```

### 11. exceptions/ - –ò—Å–∫–ª—é—á–µ–Ω–∏—è

–ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä:

- `UnknownKeyboardButtonPropertyError` - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –∫–Ω–æ–ø–∫–∏
- `NotEnoughArgsToCreateButtonError` - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
- `TooManyArgsToCreateButtonError` - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
- `WrongKeyboardSchemaError` - –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—Ö–µ–º–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- `PaymentButtonMustBeFirstError` - –∫–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ –ø–µ—Ä–≤–∞—è

### 12. web_handlers/ - Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö webhook –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram:

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ bot_id
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ aiojobs

## –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
   - Polling: –±–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   - Webhook: Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å

2. **Middleware:**
   - `StructLoggingMiddleware` –ª–æ–≥–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
   - –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç update_id –∫–æ –≤—Å–µ–º –ª–æ–≥–≥–µ—Ä–∞–º

3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
   - –§–∏–ª—å—Ç—Ä—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç, –∫–∞–∫–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

4. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫:**
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
   - –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ë–î —á–µ—Ä–µ–∑ `db_conn`
   - –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à —á–µ—Ä–µ–∑ `cache_pool`
   - –ú–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ

5. **–û—Ç–≤–µ—Ç:**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
   - –ò —Ç.–¥.

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ structlog:

**–¢–∏–ø—ã –ª–æ–≥–≥–µ—Ä–æ–≤:**

- `aiogram_logger` - –ª–æ–≥–∏ aiogram
- `aiogram_session_logger` - –ª–æ–≥–∏ —Å–µ—Å—Å–∏–π API
- `db_logger` - –ª–æ–≥–∏ –ë–î
- `cache_logger` - –ª–æ–≥–∏ –∫—ç—à–∞
- `business_logger` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

**–§–æ—Ä–º–∞—Ç:**

- –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Å —Ü–≤–µ—Ç–∞–º–∏
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: JSON –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**

–í—Å–µ –ª–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç:
- `update_id` - ID –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `chat_id` - ID —á–∞—Ç–∞
- –ò –¥—Ä—É–≥—É—é —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–∏—Å–∞–º

### PostgreSQL

```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
db_pool: asyncpg.Pool = dp["db_pool"]
db_conn = PostgresConnection(db_pool, dp["db_logger"])

result = await db_conn._fetchrow("SELECT * FROM users WHERE id = $1", (user_id,))
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- Connection pooling (min_size=1, max_size=3)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON/JSONB —Å orjson
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### Redis (FSM)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM:

```python
storage = RedisStorage(
    redis=Redis(host=config.FSM_HOST, port=config.FSM_PORT, password=config.FSM_PASSWORD),
    key_builder=DefaultKeyBuilder(with_bot_id=True)
)
```

### Redis (Cache) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

–î–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

```python
if config.USE_CACHE:
    cache_pool: Redis = dp["cache_pool"]
    await cache_pool.set("key", "value", ex=3600)
    value = await cache_pool.get("key")
```

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:**

```python
# handlers/user/profile.py
from aiogram import types
from aiogram.fsm.context import FSMContext

async def show_profile(msg: types.Message, state: FSMContext) -> None:
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
    pass
```

2. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ —Ä–æ—É—Ç–µ—Ä–µ:**

```python
# handlers/user/__init__.py
from . import profile

def prepare_router() -> Router:
    user_router = Router()
    user_router.message.register(profile.show_profile, TextFilter("üë§ –ü—Ä–æ—Ñ–∏–ª—å"))
    return user_router
```

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**

```python
user_router.message.register(
    handler,
    TextFilter("—Ç–µ–∫—Å—Ç"),
    StateFilter(states.user.UserMainMenu.menu)
)
```

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä

### Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

```python
# keyboards/default/menu.py
from .consts import DefaultConstructor

class MenuButtons(DefaultConstructor):
    @staticmethod
    def main_menu() -> ReplyKeyboardMarkup:
        schema = [2, 1]
        btns = ["–ö–Ω–æ–ø–∫–∞1", "–ö–Ω–æ–ø–∫–∞2", "–ö–Ω–æ–ø–∫–∞3"]
        return MenuButtons._create_kb(btns, schema)
```

### Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

```python
# keyboards/inline/user/menu.py
from ..consts import InlineConstructor
from ..callbacks import Action

class UserMenu(InlineConstructor):
    @staticmethod
    def main_menu() -> InlineKeyboardMarkup:
        schema = [1, 1]
        btns = [
            {"text": "–ö–Ω–æ–ø–∫–∞1", "callback_data": Action(action="action1")},
            {"text": "–ö–Ω–æ–ø–∫–∞2", "callback_data": Action(action="action2")},
        ]
        return UserMenu._create_kb(btns, schema)
```

## –†–∞–±–æ—Ç–∞ —Å FSM

```python
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
await state.set_state(states.user.UserMainMenu.menu)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è
data = await state.get_data()
await state.update_data(key="value")

# –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
await state.clear()
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ callback_query

```python
from aiogram import types
from bowling_bot.keyboards.inline.callbacks import Action

async def handle_callback(
    callback: types.CallbackQuery,
    callback_data: Action,
    state: FSMContext
) -> None:
    if callback_data.action == "do_something":
        await callback.answer("–í—ã–ø–æ–ª–Ω–µ–Ω–æ!")
        await callback.message.edit_text("–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç")
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `example.env` –≤ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
BOT_TOKEN=your_bot_token
PG_HOST=localhost
PG_PORT=5432
PG_USER=postgres
PG_PASSWORD=password
PG_DATABASE=bot_db
FSM_HOST=127.0.0.1
FSM_PORT=6379
FSM_PASSWORD=

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
USE_CACHE=false
USE_WEBHOOK=false
LOGGING_LEVEL=10  # DEBUG=10, INFO=20, WARNING=30, ERROR=40
DROP_PREVIOUS_UPDATES=false
```

## –ó–∞–ø—É—Å–∫

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (Polling)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
poetry install

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env
cp example.env .env
# –ó–∞–ø–æ–ª–Ω–∏—Ç–µ .env

# –ó–∞–ø—É—Å–∫
poetry run python -m bowling_bot.bot
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω (Webhook)

```bash
# –í .env —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ
USE_WEBHOOK=true
MAIN_WEBHOOK_ADDRESS=https://yourdomain.com/tg/webhooks/bot/{bot_id}
MAIN_WEBHOOK_SECRET_TOKEN=your_secret_token
MAIN_WEBHOOK_LISTENING_HOST=0.0.0.0
MAIN_WEBHOOK_LISTENING_PORT=8080
```

## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

–î–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –ø–æ–¥ –≤–∞—à –ø—Ä–æ–µ–∫—Ç:

```bash
make init_project
```

–°–∫—Ä–∏–ø—Ç:
- –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ—Ç –ø–∞–ø–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –û–±–Ω–æ–≤–∏—Ç –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã
- –û–±–Ω–æ–≤–∏—Ç pyproject.toml
- –û–±–Ω–æ–≤–∏—Ç Makefile

## –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
make lint
```

–í—ã–ø–æ–ª–Ω—è–µ—Ç:
- `ruff` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
- `isort` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
- `mypy` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
- `black` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
   - Handlers - —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - Repositories - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
   - Services - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FSM:**
   - –î–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
   - –î–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ª–æ–≥–≥–µ—Ä
   - –î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ `.bind()`

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ try/except –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ connection pooling
   - –ö—ç—à–∏—Ä—É–π—Ç–µ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –≤ `handlers/` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `admin/`)
2. –°–æ–∑–¥–∞–π—Ç–µ `__init__.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `prepare_router()`
3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ `bot.py`: `dp.include_router(handlers.admin.prepare_router())`

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ë–î

1. –ù–∞—Å–ª–µ–¥—É–π—Ç–µ—Å—å –æ—Ç `BaseConnection`
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ `_fetch`, `_fetchrow`, `_execute`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–π—Å—è –æ—Ç `BaseFilter`
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ `async def __call__()`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫—É webhook –∏ polling
- ‚úÖ –£–¥–æ–±–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä
- ‚úÖ FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- ‚úÖ –ì–æ—Ç–æ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∫–∞–∫ –æ—Å–Ω–æ–≤—É –¥–ª—è –≤–∞—à–∏—Ö Telegram-–±–æ—Ç–æ–≤!


# Диаграммы потоков и архитектуры

## Поток обработки обновления

```
┌─────────────────────────────────────────────────────────────────┐
│                    Получение обновления                         │
├─────────────────────────────────────────────────────────────────┤
│  Polling Mode:                    Webhook Mode:                  │
│  Bot запрашивает обновления      Telegram отправляет POST       │
│  у Telegram API                  на ваш сервер                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Dispatcher получает Update                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              StructLoggingMiddleware                            │
│  • Извлекает информацию из Update                               │
│  • Привязывает update_id ко всем логгерам                       │
│  • Логирует начало обработки                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Фильтрация                                   │
│  • ChatTypeFilter - тип чата                                    │
│  • TextFilter - текст сообщения                                 │
│  • StateFilter - текущее состояние FSM                          │
│  • Command - команды                                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Выбор обработчика (Handler)                        │
│  • Поиск подходящего обработчика                                │
│  • Проверка всех фильтров                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Выполнение обработчика                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  async def handler(                                      │  │
│  │      msg: Message,                                       │  │
│  │      state: FSMContext,                                  │  │
│  │      db_conn: PostgresConnection,                        │  │
│  │      cache_pool: Redis,                                  │  │
│  │      business_logger: Logger,                            │  │
│  │  ) -> None:                                              │  │
│  │      # Бизнес-логика                                     │  │
│  │      # Работа с БД                                       │  │
│  │      # Изменение состояния                               │  │
│  │      # Отправка ответа                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Отправка ответа                                    │
│  • msg.answer() - отправка сообщения                            │
│  • msg.reply() - ответ на сообщение                             │
│  • callback.answer() - ответ на callback                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              StructLoggingMiddleware (завершение)                │
│  • Логирует завершение обработки                                │
│  • Записывает время выполнения                                  │
│  • Логирует результат                                           │
└─────────────────────────────────────────────────────────────────┘
```

## Архитектура компонентов

```
┌─────────────────────────────────────────────────────────────────┐
│                         bot.py                                   │
│  • Инициализация Bot и Dispatcher                               │
│  • Настройка storage (Redis для FSM)                            │
│  • Регистрация handlers и middlewares                            │
│  • Запуск polling или webhook                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Handlers    │    │ Middlewares  │    │   Filters    │
│              │    │              │    │              │
│  • user/     │    │  • Logging   │    │  • ChatType  │
│  • admin/    │    │              │    │  • Text      │
│  • errors/   │    │              │    │  • State    │
└──────────────┘    └──────────────┘    └──────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Бизнес-логика                                 │
│  • Обработка сообщений                                          │
│  • Работа с FSM состояниями                                     │
│  • Создание клавиатур                                           │
└─────────────────────────────────────────────────────────────────┘
        │
        ├─────────────────────┬─────────────────────┐
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Database    │    │    Cache     │    │   States     │
│              │    │              │    │              │
│  PostgreSQL  │    │    Redis     │    │  Redis FSM   │
│  • Users     │    │  • Sessions  │    │  • Menu      │
│  • Data      │    │  • Temp data │    │  • Dialog    │
└──────────────┘    └──────────────┘    └──────────────┘
```

## Поток инициализации бота

```
┌─────────────────────────────────────────────────────────────────┐
│                    main() функция                                │
│  • Создание Bot с SmartAiogramAiohttpSession                    │
│  • Создание Dispatcher с RedisStorage                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              setup_aiogram()                                    │
│  • setup_logging() - настройка логгеров                         │
│  • create_db_connections() - подключение к БД                   │
│  • setup_handlers() - регистрация обработчиков                  │
│  • setup_middlewares() - регистрация middleware                 │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Logging     │    │   Database   │    │  Handlers    │
│              │    │              │    │              │
│  • aiogram   │    │  • PostgreSQL│    │  • user/     │
│  • db        │    │    (retry)   │    │  • admin/    │
│  • cache     │    │  • Redis     │    │              │
│  • business  │    │    (retry)   │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Режим работы                                       │
│                                                                  │
│  ┌──────────────────────┐    ┌──────────────────────┐         │
│  │   Polling Mode       │    │   Webhook Mode        │         │
│  │                      │    │                       │         │
│  │  dp.start_polling()  │    │  web.run_app()        │         │
│  │                      │    │  • aiohttp server     │         │
│  │  • Простой запуск    │    │  • /tg/webhooks/      │         │
│  │  • Для разработки    │    │  • Для продакшена     │         │
│  └──────────────────────┘    └──────────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## Поток работы с БД

```
┌─────────────────────────────────────────────────────────────────┐
│              Обработчик получает запрос                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Получение db_conn из dp                            │
│  db_conn: PostgresConnection = dp["db_conn"]                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Выполнение запроса                                  │
│  • _fetchrow() - один результат                                 │
│  • _fetch() - несколько результатов                             │
│  • _execute() - выполнение без результата                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Connection Pool                                    │
│  • asyncpg.Pool (min_size=1, max_size=3)                        │
│  • Автоматическое управление соединениями                        │
│  • Переиспользование соединений                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              PostgreSQL                                          │
│  • Выполнение SQL запроса                                        │
│  • Возврат результата                                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Обработка результата                               │
│  • SingleQueryResult / MultipleQueryResults                      │
│  • Конвертация в Pydantic модели                                │
│  • Логирование запроса и времени выполнения                     │
└─────────────────────────────────────────────────────────────────┘
```

## Поток работы с FSM

```
┌─────────────────────────────────────────────────────────────────┐
│              Пользователь отправляет сообщение                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Обработчик получает state                           │
│  state: FSMContext                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Проверка текущего состояния                        │
│  current_state = await state.get_state()                         │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Установка   │    │  Получение   │    │  Обновление  │
│  состояния   │    │  данных      │    │  данных      │
│              │    │              │    │              │
│  set_state() │    │  get_data()  │    │ update_data()│
└──────────────┘    └──────────────┘    └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              RedisStorage                                        │
│  • Сохранение состояния в Redis                                 │
│  • Ключ: fsm_key:{bot_id}:{user_id}:{chat_id}                  │
│  • TTL для автоматической очистки                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Redis                                               │
│  • Хранение состояний всех пользователей                        │
│  • Быстрый доступ                                               │
│  • Персистентность (опционально)                                │
└─────────────────────────────────────────────────────────────────┘
```

## Поток создания клавиатуры

```
┌─────────────────────────────────────────────────────────────────┐
│              Создание клавиатуры                                 │
│  keyboard = BasicButtons.main_menu()                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Определение схемы и кнопок                          │
│  schema = [2, 1]  # 2 кнопки в первой строке, 1 во второй        │
│  btns = ["Кнопка1", "Кнопка2", "Кнопка3"]                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Валидация                                           │
│  • Проверка соответствия схемы количеству кнопок                │
│  • Проверка обязательных свойств                                 │
│  • Проверка дополнительных свойств                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              create_keyboard_layout()                           │
│  • Разбиение кнопок по строкам согласно схеме                   │
│  • Создание структуры [[btn1, btn2], [btn3]]                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Создание KeyboardButton                             │
│  • Для reply-клавиатур: KeyboardButton                          │
│  • Для inline-клавиатур: InlineKeyboardButton                   │
│  • Упаковка callback_data (для inline)                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Возврат клавиатуры                                  │
│  ReplyKeyboardMarkup или InlineKeyboardMarkup                    │
└─────────────────────────────────────────────────────────────────┘
```

## Поток логирования

```
┌─────────────────────────────────────────────────────────────────┐
│              Событие в системе                                   │
│  • Получение обновления                                          │
│  • Запрос к БД                                                   │
│  • API запрос                                                    │
│  • Бизнес-логика                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Выбор логгера                                       │
│  • aiogram_logger - для aiogram событий                         │
│  • db_logger - для запросов к БД                                │
│  • cache_logger - для работы с кэшем                            │
│  • business_logger - для бизнес-логики                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Привязка контекста                                  │
│  logger = logger.bind(                                           │
│      update_id=123,                                              │
│      user_id=456,                                                │
│      action="something"                                          │
│  )                                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Обработка процессорами                              │
│  • add_log_level - добавление уровня                            │
│  • TimeStamper - добавление времени                             │
│  • dict_tracebacks - форматирование traceback                   │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Терминал    │    │  JSON        │    │  Файл        │
│              │    │              │    │              │
│  Console     │    │  JSONRenderer│    │  (опционально)│
│  Renderer    │    │              │    │              │
│  (rich)      │    │  для продакшена  │              │
└──────────────┘    └──────────────┘    └──────────────┘
```

## Поток обработки webhook

```
┌─────────────────────────────────────────────────────────────────┐
│              Telegram отправляет Update                          │
│  POST /tg/webhooks/bot/{bot_id}                                 │
│  Headers: X-Telegram-Bot-Api-Secret-Token                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Nginx (опционально)                                 │
│  • SSL termination                                               │
│  • Проксирование на aiohttp                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              aiohttp приложение                                  │
│  • Проверка секретного токена                                    │
│  • Проверка bot_id                                               │
│  • Проверка размера очереди                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              aiojobs Scheduler                                   │
│  • Добавление задачи в очередь                                  │
│  • Асинхронная обработка                                         │
│  • Ограничение размера очереди                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              process_update()                                    │
│  • Парсинг JSON в Update                                         │
│  • Вызов dp.feed_webhook_update()                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Обычный поток обработки                             │
│  (см. "Поток обработки обновления")                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              Возврат HTTP 200                                    │
│  (Telegram не ждет ответа, но нужен статус)                     │
└─────────────────────────────────────────────────────────────────┘
```

## Взаимодействие компонентов

```
                    ┌─────────────┐
                    │   Telegram  │
                    │     API     │
                    └──────┬──────┘
                           │
                           │ Updates
                           │
        ┌──────────────────┴──────────────────┐
        │                                     │
        ▼                                     ▼
┌──────────────┐                    ┌──────────────┐
│   Polling    │                    │   Webhook    │
│    Mode      │                    │    Mode      │
└──────┬───────┘                    └──────┬───────┘
       │                                    │
       └──────────────┬────────────────────┘
                      │
                      ▼
            ┌─────────────────┐
            │   Dispatcher    │
            └────────┬────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│Handlers  │  │Middleware│  │ Filters  │
└────┬─────┘  └────┬─────┘  └────┬─────┘
     │            │            │
     └────────────┼────────────┘
                  │
        ┌─────────┼─────────┐
        │         │         │
        ▼         ▼         ▼
  ┌────────┐ ┌────────┐ ┌────────┐
  │   DB   │ │ Cache  │ │ States │
  │(PostgreSQL)│(Redis)│ │(Redis) │
  └────────┘ └────────┘ └────────┘
```

## Схема данных в Dispatcher

```
Dispatcher.workflow_data = {
    "aiogram_logger": FilteringBoundLogger,
    "db_logger": FilteringBoundLogger,
    "cache_logger": FilteringBoundLogger,
    "business_logger": FilteringBoundLogger,
    "aiogram_session_logger": FilteringBoundLogger,
    "db_pool": asyncpg.Pool,
    "cache_pool": Redis (опционально),
    "temp_bot_cloud_session": AiohttpSession,
    "temp_bot_local_session": AiohttpSession (опционально),
}
```

## Жизненный цикл бота

```
┌─────────────────────────────────────────────────────────────────┐
│                    Запуск (startup)                            │
│  • Создание Bot и Dispatcher                                    │
│  • Настройка логирования                                        │
│  • Подключение к БД (с повторами)                               │
│  • Регистрация handlers                                         │
│  • Регистрация middlewares                                      │
│  • Настройка webhook (если USE_WEBHOOK=true)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Работа (running)                             │
│  • Обработка обновлений                                         │
│  • Выполнение бизнес-логики                                     │
│  • Работа с БД                                                  │
│  • Управление состояниями                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Остановка (shutdown)                         │
│  • Ожидание завершения задач в очереди                         │
│  • Закрытие соединений с БД                                     │
│  • Закрытие сессий aiogram                                      │
│  • Закрытие storage (Redis)                                     │
│  • Удаление webhook (если был установлен)                      │
└─────────────────────────────────────────────────────────────────┘
```

Эти диаграммы помогут визуализировать работу шаблона и понять взаимодействие компонентов.

